digraph MatmulComputeGraphFastWeightLoad {
    rankdir=LR;
    bgcolor="white";
    pad=0.5;
    dpi=300;

    // Graph styling
    node [fontname="Arial", fontsize=11, style="filled,rounded", shape=box];
    edge [fontname="Arial", fontsize=9];

    // Title
    label="Fast Weight Load Transform: Before and After\nSwap stationary/moving when M is small (M=64)\nR becomes stationary for 4× faster load";
    labelloc="t";
    fontsize=14;
    fontname="Arial Bold";

    // ==================== BEFORE ====================
    subgraph cluster_before {
        label="BEFORE: L stationary (default)";
        style="dashed";
        color="#888888";
        fontsize=12;

        subgraph cluster_before_0 {
            label="Subgraph 0\n(M_tile=0, N_tile=0)";

            before_alloc_L [label="L_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_alloc_R [label="R_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_alloc_L_T [label="L_T_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_alloc_out [label="out_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];

            before_load_L [label="load(L[0, :],\ndst=L_sbuf_0)\n[64, 128]", fillcolor="#FFEAA7"];
            before_load_R [label="load(R[:, 0],\ndst=R_sbuf_0)\n[128, 512]", fillcolor="#FFEAA7"];

            before_transpose_L [label="L_T_0 =\ntranspose(L_sbuf_0)\n[128, 64]", fillcolor="#DDA0DD"];

            before_compute [label="nc_matmul(L_T_0, R_sbuf_0,\nresult=out_sbuf_0)\n(L stationary: slow)\nResult: [64, 512]", fillcolor="#A8D8EA"];

            before_store [label="store(out_sbuf_0,\ndst=Output[0,0])", fillcolor="#A8E6CF"];

            before_alloc_L -> before_load_L [label="L_sbuf_0", color="#666666"];
            before_alloc_R -> before_load_R [label="R_sbuf_0", color="#666666"];
            before_alloc_L_T -> before_transpose_L [label="L_T_0", color="#666666"];
            before_alloc_out -> before_compute [label="out_sbuf_0", color="#666666"];
            before_load_L -> before_transpose_L [label="L_sbuf_0", color="#666666"];
            before_transpose_L -> before_compute [label="L_T_0", color="#666666"];
            before_load_R -> before_compute [label="R_sbuf_0", color="#666666"];
            before_compute -> before_store [label="out_sbuf_0", color="#666666"];
        }
    }

    // ==================== AFTER ====================
    subgraph cluster_after {
        label="AFTER: R stationary (swapped for fast load)";
        style="dashed";
        color="#888888";
        fontsize=12;

        subgraph cluster_after_0 {
            label="Subgraph 0 (after swap)\n(M_tile=0, N_tile=0)";

            alloc_L [label="L_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_R [label="R_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_L_T [label="L_T_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_temp [label="temp_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_out [label="out_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];

            load_L [label="load(L[0, :],\ndst=L_sbuf_0)\n[64, 128]", fillcolor="#FFEAA7"];
            load_R [label="load(R[:, 0],\ndst=R_sbuf_0)\n[128, 512]", fillcolor="#FFEAA7"];

            transpose_L [label="L_T_0 =\ntranspose(L_sbuf_0)\n[128, 64]", fillcolor="#DDA0DD"];

            compute [label="nc_matmul(R_sbuf_0, L_T_0,\nresult=temp_0)\n(R stationary: fast, 4×)\nResult: [512, 64]", fillcolor="#A8D8EA", penwidth=2];

            transpose_out [label="out_sbuf_0 =\ntranspose(temp_0)\n[64, 512]\n(extra cost from swap)", fillcolor="#DDA0DD", penwidth=2];

            store [label="store(out_sbuf_0,\ndst=Output[0,0])", fillcolor="#A8E6CF"];

            alloc_L -> load_L [label="L_sbuf_0", color="#666666"];
            alloc_R -> load_R [label="R_sbuf_0", color="#666666"];
            alloc_L_T -> transpose_L [label="L_T_0", color="#666666"];
            alloc_temp -> compute [label="temp_0", color="#666666"];
            alloc_out -> transpose_out [label="out_sbuf_0", color="#666666"];
            load_L -> transpose_L [label="L_sbuf_0", color="#666666"];
            transpose_L -> compute [label="L_T_0", color="#666666"];
            load_R -> compute [label="R_sbuf_0", color="#666666"];
            compute -> transpose_out [label="temp_0", color="#666666"];
            transpose_out -> store [label="out_sbuf_0", color="#666666"];
        }
    }

    // Layout hint
    before_store -> alloc_L [style="invis", weight=0];

}
