digraph MatmulComputeGraphDataReuse {
    rankdir=LR;
    bgcolor="white";
    pad=0.5;
    dpi=300;

    // Graph styling
    node [fontname="Arial", fontsize=11, style="filled,rounded", shape=box];
    edge [fontname="Arial", fontsize=9];

    // Title
    label="Data Reuse Transform: Before and After\nMerge subgraphs that share L[0, :]\nEdge labels show tensor data flow";
    labelloc="t";
    fontsize=14;
    fontname="Arial Bold";

    // ==================== BEFORE ====================
    subgraph cluster_before {
        label="BEFORE: Separate Subgraphs";
        style="dashed";
        color="#888888";
        fontsize=12;

        // Subgraph 0: Output[0,0]
        subgraph cluster_before_0 {
            label="Subgraph 0\n(M_tile=0, N_tile=0)";

            before_alloc_L_0 [label="L_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_alloc_R_0 [label="R_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_alloc_out_0 [label="out_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_load_L_0 [label="load(L[0, :],\ndst=L_sbuf_0)", fillcolor="#FFEAA7"];
            before_load_R_0 [label="load(R[:, 0],\ndst=R_sbuf_0)", fillcolor="#FFEAA7"];
            before_compute_0 [label="matmul(L_sbuf_0,\nR_sbuf_0, out_sbuf_0)", fillcolor="#A8D8EA"];
            before_store_0 [label="store(out_sbuf_0,\ndst=Output[0,0])", fillcolor="#A8E6CF"];

            before_alloc_L_0 -> before_load_L_0 [label="L_sbuf_0", color="#666666"];
            before_alloc_R_0 -> before_load_R_0 [label="R_sbuf_0", color="#666666"];
            before_alloc_out_0 -> before_compute_0 [label="out_sbuf_0", color="#666666"];
            before_load_L_0 -> before_compute_0 [label="L_sbuf_0", color="#666666"];
            before_load_R_0 -> before_compute_0 [label="R_sbuf_0", color="#666666"];
            before_compute_0 -> before_store_0 [label="out_sbuf_0", color="#666666"];
        }

        // Subgraph 1: Output[0,1]
        subgraph cluster_before_1 {
            label="Subgraph 1\n(M_tile=0, N_tile=1)";

            before_alloc_L_1 [label="L_sbuf_1 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_alloc_R_1 [label="R_sbuf_1 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_alloc_out_1 [label="out_sbuf_1 =\nndarray(...)", fillcolor="#E8E8E8"];
            before_load_L_1 [label="load(L[0, :],\ndst=L_sbuf_1)", fillcolor="#FFEAA7"];
            before_load_R_1 [label="load(R[:, 1],\ndst=R_sbuf_1)", fillcolor="#FFEAA7"];
            before_compute_1 [label="matmul(L_sbuf_1,\nR_sbuf_1, out_sbuf_1)", fillcolor="#A8D8EA"];
            before_store_1 [label="store(out_sbuf_1,\ndst=Output[0,1])", fillcolor="#A8E6CF"];

            before_alloc_L_1 -> before_load_L_1 [label="L_sbuf_1", color="#666666"];
            before_alloc_R_1 -> before_load_R_1 [label="R_sbuf_1", color="#666666"];
            before_alloc_out_1 -> before_compute_1 [label="out_sbuf_1", color="#666666"];
            before_load_L_1 -> before_compute_1 [label="L_sbuf_1", color="#666666"];
            before_load_R_1 -> before_compute_1 [label="R_sbuf_1", color="#666666"];
            before_compute_1 -> before_store_1 [label="out_sbuf_1", color="#666666"];
        }
    }

    // ==================== AFTER ====================
    subgraph cluster_after {
        label="AFTER: Merged Subgraph (shared L_sbuf_0)";
        style="dashed";
        color="#888888";
        fontsize=12;

        // Merged subgraph 0+1: Outputs[0,0] and [0,1]
        subgraph cluster_merged_01 {
            label="Merged Subgraph 0+1: Output[0,:]";
            penwidth=2;

            // Allocate nodes (shared L_sbuf_0, separate R and out buffers)
            alloc_L_shared [label="L_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8", penwidth=2];
            alloc_R_00 [label="R_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_out_00 [label="out_sbuf_0 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_R_01 [label="R_sbuf_1 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_out_01 [label="out_sbuf_1 =\nndarray(...)", fillcolor="#E8E8E8"];

            // Shared L load for this merged subgraph
            load_L_shared [label="load(L[0, :],\ndst=L_sbuf_0)", fillcolor="#FFEAA7", penwidth=2];

            // Compute Output[0,0]
            load_R_00 [label="load(R[:, 0],\ndst=R_sbuf_0)", fillcolor="#FFEAA7"];
            compute_00 [label="out_sbuf_0 =\nnc_matmul(L_sbuf_0, R_sbuf_0)", fillcolor="#A8D8EA"];
            store_00 [label="store(out_sbuf_0,\ndst=Output[0,0])", fillcolor="#A8E6CF"];

            // Compute Output[0,1]
            load_R_01 [label="load(R[:, 1],\ndst=R_sbuf_1)", fillcolor="#FFEAA7"];
            compute_01 [label="out_sbuf_1 =\nnc_matmul(L_sbuf_0, R_sbuf_1)", fillcolor="#A8D8EA"];
            store_01 [label="store(out_sbuf_1,\ndst=Output[0,1])", fillcolor="#A8E6CF"];

            // Allocate edges
            alloc_L_shared -> load_L_shared [label="L_sbuf_0", color="#666666"];
            alloc_R_00 -> load_R_00 [label="R_sbuf_0", color="#666666"];
            alloc_out_00 -> compute_00 [label="out_sbuf_0", color="#666666"];
            alloc_R_01 -> load_R_01 [label="R_sbuf_1", color="#666666"];
            alloc_out_01 -> compute_01 [label="out_sbuf_1", color="#666666"];

            // Data flow edges
            load_L_shared -> compute_00 [label="L_sbuf_0", color="#666666", penwidth=2];
            load_L_shared -> compute_01 [label="L_sbuf_0", color="#666666", penwidth=2];
            load_R_00 -> compute_00 [label="R_sbuf_0", color="#666666"];
            load_R_01 -> compute_01 [label="R_sbuf_1", color="#666666"];
            compute_00 -> store_00 [label="out_sbuf_0", color="#666666"];
            compute_01 -> store_01 [label="out_sbuf_1", color="#666666"];
        }
    }

    // Transform arrow between before and after
    before_store_0 -> alloc_L_shared [style="invis", weight=0];
    before_store_1 -> alloc_L_shared [style="invis", weight=0];

}
