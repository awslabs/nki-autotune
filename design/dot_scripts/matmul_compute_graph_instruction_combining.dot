digraph MatmulComputeGraphInstructionCombining {
    rankdir=LR;
    bgcolor="white";
    pad=0.5;
    dpi=300;

    // Graph styling
    node [fontname="Arial", fontsize=11, style="filled,rounded", shape=box];
    edge [fontname="Arial", fontsize=9];

    // Title
    label="Instruction Combining Transform: Before and After\nFuse scale → bias → activation into single instruction";
    labelloc="t";
    fontsize=14;
    fontname="Arial Bold";

    // ==================== BEFORE ====================
    subgraph cluster_before {
        label="BEFORE: Separate Instructions";
        style="dashed";
        color="#888888";
        fontsize=12;

        subgraph cluster_separate {
            label="3 separate ops + 2 temp buffers";
            penwidth=2;
            color="#FF6B6B";

            alloc_input_sep [label="input_sbuf =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_temp1_sep [label="temp1 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_temp2_sep [label="temp2 =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_result_sep [label="result =\nndarray(...)", fillcolor="#E8E8E8"];

            load_sep [label="load(input,\ndst=input_sbuf)", fillcolor="#FFEAA7"];

            multiply_sep [label="multiply(input_sbuf,\nscale, dst=temp1)", fillcolor="#A8D8EA"];
            add_sep [label="add(temp1, bias,\ndst=temp2)", fillcolor="#A8D8EA"];
            exp_sep [label="exp(temp2,\ndst=result)", fillcolor="#A8D8EA"];

            store_sep [label="store(result,\ndst=output)", fillcolor="#A8E6CF"];

            alloc_input_sep -> load_sep [label="input_sbuf", color="#666666"];
            alloc_temp1_sep -> multiply_sep [label="temp1", color="#666666"];
            alloc_temp2_sep -> add_sep [label="temp2", color="#666666"];
            alloc_result_sep -> exp_sep [label="result", color="#666666"];
            load_sep -> multiply_sep [label="input_sbuf", color="#666666"];
            multiply_sep -> add_sep [label="temp1", color="#666666"];
            add_sep -> exp_sep [label="temp2", color="#666666"];
            exp_sep -> store_sep [label="result", color="#666666"];
        }
    }

    // ==================== AFTER ====================
    subgraph cluster_after {
        label="AFTER: Fused Instruction";
        style="dashed";
        color="#888888";
        fontsize=12;

        subgraph cluster_combined {
            label="1 fused op, no temp buffers";
            penwidth=2;
            color="#4169E1";

            alloc_input_comb [label="input_sbuf =\nndarray(...)", fillcolor="#E8E8E8"];
            alloc_result_comb [label="result =\nndarray(...)", fillcolor="#E8E8E8"];

            load_comb [label="load(input,\ndst=input_sbuf)", fillcolor="#FFEAA7"];

            activation_comb [label="activation(input_sbuf,\n           op=exp,\n           bias=bias,\n           scale=scale,\n           dst=result)\n[Fused: multiply+add+exp]",
                            fillcolor="#A8D8EA", penwidth=3, style="filled,rounded,bold"];

            store_comb [label="store(result,\ndst=output)", fillcolor="#A8E6CF"];

            alloc_input_comb -> load_comb [label="input_sbuf", color="#666666"];
            alloc_result_comb -> activation_comb [label="result", color="#666666"];
            load_comb -> activation_comb [label="input_sbuf", color="#666666"];
            activation_comb -> store_comb [label="result", color="#666666"];
        }
    }

    // Layout hint
    store_sep -> alloc_input_comb [style="invis", weight=0];

}
